<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Sentimo - Emotion Detection</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body { background: linear-gradient(135deg,#a1c4fd,#c2e9fb); text-align:center; font-family:"Poppins",sans-serif; padding:20px;}
h1{font-size:2.4em;color:#3c3b6e;}
#project-title{color:#f9a825;font-size:1.4em;margin-bottom:20px;}
#camera-container{width:100%; max-width:520px;margin:auto;border-radius:16px;overflow:hidden;background:white;box-shadow:0 4px 14px rgba(0,0,0,0.2); display:none;}
#camera-container img{width:100%; height:auto;}
#emotion-name{margin-top:18px;font-size:1.8em;color:#3c3b6e;}
#joke-box{display:none;background:white;padding:14px;margin-top:20px;border-radius:10px;max-width:520px;margin:auto;font-size:1.1em;box-shadow:0 4px 10px rgba(0,0,0,.15);}
#joke-button{display:none;margin-top:12px;padding:10px 25px;border:none;border-radius:20px;background:#6c5b7b;color:white;font-size:1.1em;}
#loading-spinner{display:none;width:40px;height:40px;margin:20px auto;border-radius:50%;border:4px solid #ddd;border-top-color:#3498db;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
#start-btn{padding:15px 30px;font-size:1.2em;border:none;border-radius:25px;background:#3c3b6e;color:white;cursor:pointer;margin-top:20px;}
</style>
</head>
<body>

<h1>Sentimo</h1>
<div id="project-title">Emotion Detection</div>

<!-- Start Camera & Audio -->
<button id="start-btn">Start Camera & Detection</button>

<div id="camera-container">
    <img id="video-feed" src="">
</div>

<div id="emotion-name">Waiting to start...</div>

<div id="loading-spinner"></div>

<div id="joke-box"></div>
<button id="joke-button">Tell me a joke</button>

<audio id="sleepy-sound" src="/static/sleep.mp3" preload="auto"></audio>

<script>
let ws = null;
let lastEmotion = "";
let audioUnlocked = false;
let sendInFlight = false;

const sleepySound = document.getElementById("sleepy-sound");
const startButton = document.getElementById("start-btn");
const cameraContainer = document.getElementById("camera-container");
const emotionText = document.getElementById("emotion-name");
const jokeBox = document.getElementById("joke-box");
const jokeBtn = document.getElementById("joke-button");
const loadingSpinner = document.getElementById("loading-spinner");
const videoFeed = document.getElementById("video-feed");

/* ------------------------------
     AUDIO UNLOCK
------------------------------ */
const unlockAudio = () => {
    sleepySound.play().then(() => {
        sleepySound.pause();
        sleepySound.currentTime = 0;
        audioUnlocked = true;
        console.debug("Audio unlocked");
    }).catch(err => console.log("Audio autoplay blocked:", err));
};

/* ------------------------------
     START BUTTON LOGIC
------------------------------ */
startButton.onclick = async () => {
    startButton.style.display = "none";
    cameraContainer.style.display = "block";
    loadingSpinner.style.display = "block";

    unlockAudio();

    const wsURL =
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host +
        "/ws";

    console.log("Connecting to WebSocket:", wsURL);
    ws = new WebSocket(wsURL);

    ws.onopen = () => {
        console.log("WebSocket connected");
        // heartbeat every 15s
        window.__sentimo_heartbeat = setInterval(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN) { clearInterval(window.__sentimo_heartbeat); return; }
            try {
                ws.send(JSON.stringify({ type: "ping" }));
                console.debug("Sent WS ping");
            } catch (e) {
                console.error("Heartbeat send error:", e);
                clearInterval(window.__sentimo_heartbeat);
            }
        }, 15000);
    };

    ws.onmessage = (event) => {
        console.log("WS incoming raw:", event.data);

        let data = null;
        try {
            data = JSON.parse(event.data);
        } catch (e) {
            console.error("Error parsing WS message JSON:", e, "raw:", event.data);
            // clear in-flight so next frame can be sent
            sendInFlight = false;
            return;
        }

        if (data.emotion) {
            emotionText.textContent = data.emotion;
        }

        if (data.joke) {
            jokeBox.style.display = "block";
            jokeBox.textContent = data.joke;
            jokeBtn.style.display = "inline-block";
        } else {
            jokeBox.style.display = "none";
            jokeBtn.style.display = "none";
        }

        const emotionLower = (data.emotion || "").toLowerCase();
        const isSleepy = emotionLower.includes("sleepy");
        const wasSleepy = (lastEmotion || "").toLowerCase().includes("sleepy");

        if (audioUnlocked) {
            if (isSleepy && !wasSleepy) {
                console.debug("Triggering sleepy sound (audioUnlocked=true)");
                sleepySound.currentTime = 0;
                sleepySound.play().catch(err => console.warn("sleepySound.play() failed:", err));
            }
            if (!isSleepy && wasSleepy) {
                sleepySound.pause();
                sleepySound.currentTime = 0;
            }
        }

        lastEmotion = data.emotion || "";
        // allow next send after server reply
        sendInFlight = false;
    };

    ws.onerror = (ev) => {
        console.error("WebSocket error:", ev);
    };
    ws.onclose = (ev) => {
        console.warn("WebSocket closed", ev);
        loadingSpinner.style.display = "block";
        if (window.__sentimo_heartbeat) { clearInterval(window.__sentimo_heartbeat); }
    };

    /* ------------------------------
        CAMERA STREAM â†’ SEND FRAMES (binary + throttled)
    ------------------------------ */
    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: false });
    const video = document.createElement("video");
    video.setAttribute("playsinline", "");
    video.muted = true;
    video.srcObject = stream;
    await video.play();

    // small canvas for sending
    const sendCanvas = document.createElement("canvas");
    sendCanvas.width = 320;
    sendCanvas.height = 240;
    const sendCtx = sendCanvas.getContext("2d");

    // preview canvas for UI (keeps UI smooth)
    const previewCanvas = document.createElement("canvas");
    const previewCtx = previewCanvas.getContext("2d");

    let lastSend = 0;
    const SEND_INTERVAL_MS = 300; // ~3 FPS (safe for Render free instance)
    const PREVIEW_UPDATE_MS = 100; // update UI preview ~10 times/sec

    function updatePreview() {
        const w = Math.min(video.videoWidth || 640, 640);
        const h = Math.min(video.videoHeight || 480, 480);
        previewCanvas.width = w;
        previewCanvas.height = h;
        previewCtx.drawImage(video, 0, 0, w, h);
        try {
            videoFeed.src = previewCanvas.toDataURL("image/jpeg", 0.6);
        } catch (e) {
            // ignore preview errors
        }
        setTimeout(updatePreview, PREVIEW_UPDATE_MS);
    }
    updatePreview();

    // send loop (throttled). We also use sendInFlight to avoid flooding server.
    const sendTicker = setInterval(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        if (sendInFlight) return;

        const now = performance.now();
        if (now - lastSend < SEND_INTERVAL_MS) return;
        lastSend = now;
        sendInFlight = true;

        // draw to send canvas and send as binary blob
        sendCtx.drawImage(video, 0, 0, sendCanvas.width, sendCanvas.height);

        // update preview quickly too (keeps UI responsive)
        try {
            videoFeed.src = sendCanvas.toDataURL("image/jpeg", 0.6);
        } catch (e) {}

        sendCanvas.toBlob((blob) => {
            if (!blob) { sendInFlight = false; return; }
            try {
                ws.send(blob);
                console.debug("Sent binary frame, size=", blob.size);
            } catch (err) {
                console.error("ws.send(blob) error:", err);
                sendInFlight = false;
            }
        }, "image/jpeg", 0.5);

    }, 80); // poll interval; actual sends controlled by SEND_INTERVAL_MS

    ws.addEventListener("close", () => {
        clearInterval(sendTicker);
    });
};

/* ------------------------------
     JOKE BUTTON ALERT
------------------------------ */
jokeBtn.onclick = () => {
    alert(jokeBox.textContent);
};
</script>

</body>
</html>
