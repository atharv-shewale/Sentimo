<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sentimo - Emotion Detection</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  body { background: linear-gradient(135deg,#a1c4fd,#c2e9fb); text-align:center; 
         font-family:"Poppins",sans-serif; padding:20px; margin:0; }
  h1 { font-size:2.2em; color:#3c3b6e; margin:6px 0; }
  #project-title { color:#f9a825; font-size:1.1em; margin-bottom:12px; }

  #camera-container { 
    width:100%; max-width:520px; margin:auto; border-radius:16px;
    overflow:hidden; background:white; box-shadow:0 4px 14px rgba(0,0,0,0.12);
    display:none; position:relative;
  }

  /* Hide raw video completely */
  #camera-container video {
    display:none !important;
  }

  /* Only canvas is visible */
  #camera-container canvas {
    display:block;
    width:100%;
    height:auto;
  }

  #emotion-name { margin-top:12px; font-size:1.6em; color:#3c3b6e; }

  #joke-box {
    display:none; background:white; padding:12px; margin-top:14px;
    border-radius:10px; max-width:520px; margin:auto; font-size:1.05em;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
  }

  #joke-button {
    display:none; margin-top:12px; padding:10px 20px;
    border:none; border-radius:20px; background:#6c5b7b;
    color:white; font-size:1.0em; cursor:pointer;
  }

  #start-btn {
    padding:12px 26px; font-size:1.05em; border:none; border-radius:22px;
    background:#3c3b6e; color:white; cursor:pointer; margin-top:18px;
  }

  #loading { margin-top:6px; color:#333; font-size:0.95em; display:none; }
</style>
</head>

<body>

<h1>Sentimo</h1>
<div id="project-title">Client-side Emotion Detection</div>

<button id="start-btn">Start Camera & Detection</button>
<div id="loading">Starting camera...</div>

<div id="camera-container">
  <video id="input_video" autoplay playsinline muted></video>
  <canvas id="output_canvas"></canvas>
</div>

<div id="emotion-name">Waiting to start...</div>

<div id="joke-box"></div>
<button id="joke-button">Tell me a joke</button>

<audio id="sleepy-sound" src="/static/sleep.mp3" preload="auto"></audio>

<!-- MediaPipe FaceMesh libraries -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
/* DOM References */
const startBtn = document.getElementById("start-btn");
const loadingEl = document.getElementById("loading");
const videoElement = document.getElementById("input_video");
const canvasElement = document.getElementById("output_canvas");
const canvasCtx = canvasElement.getContext("2d");
const emotionText = document.getElementById("emotion-name");
const jokeBox = document.getElementById("joke-box");
const jokeBtn = document.getElementById("joke-button");
const sleepySound = document.getElementById("sleepy-sound");

let audioUnlocked = false;
let lastEmotion = "";

/* Unlock audio after user gesture */
async function unlockAudio() {
  try {
    await sleepySound.play();
    sleepySound.pause();
    sleepySound.currentTime = 0;
    audioUnlocked = true;
  } catch (e) {
    console.warn("Audio unlock failed:", e);
  }
}

/* Jokes */
const JOKES = [
  "Why don't scientists trust atoms? Because they make up everything!",
  "Why did the bicycle fall over? Because it was two-tired!",
  "Why don’t skeletons fight each other? They don’t have the guts.",
  "What do you call fake spaghetti? An impasta!",
  "Why did the math book look sad? Because it had too many problems!"
];

/* FEATURE EXTRACTION — JS version of your Python */
function get_features_from_landmarks(landmarks) {
  const coords = landmarks.map(p => [p.x, p.y]);
  const xs = coords.map(c => c[0]);
  const ys = coords.map(c => c[1]);
  const width = Math.max(Math.max(...xs) - Math.min(...xs), 1e-6);
  const height = Math.max(Math.max(...ys) - Math.min(...ys), 1e-6);

  const dist = (i,j) => {
    const dx = (coords[i][0] - coords[j][0]) / width;
    const dy = (coords[i][1] - coords[j][1]) / height;
    return Math.hypot(dx, dy);
  };

  return {
    mouth_open: dist(13, 14),
    mouth_width: dist(61, 291),
    eye_open: dist(159,145) / (dist(33,133) + 1e-6),
    nose_cod: (coords[1][1] - (ys.reduce((a,b)=>a+b)/ys.length)) / height,
    inner_eye_dist: dist(133,362),
    lip_asym: (coords[61][1] - coords[291][1]) / height,
    head_tilt: (coords[234][1] - coords[454][1]) / height
  };
}

/* CLASSIFIER — JS version of your logic */
function classify_emotion_js(f) {
  const {
    mouth_open, mouth_width, eye_open,
    nose_cod, inner_eye_dist, lip_asym, head_tilt
  } = f;

  const big_mouth_open = mouth_open > 0.18;
  const strong_smile = mouth_width > 0.45 && eye_open > 0.18;
  const eyes_very_open = eye_open > 0.30;
  const eyes_narrow = eye_open < 0.18;

  if (big_mouth_open && eyes_narrow) return "sleepy";
  if (eyes_very_open && mouth_open > 0.08) return "shocked";
  if (mouth_open > 0.10 && eye_open > 0.25) return "surprised";
  if (strong_smile) return "smile";
  if (mouth_width > 0.39 && eye_open >= 0.17) return "happy";
  if (0.15 <= eye_open && eye_open < 0.20 && mouth_width < 0.04 && !big_mouth_open) return "sad";
  if (eyes_narrow && inner_eye_dist < 0.27 && mouth_width < 0.04 && !big_mouth_open) return "angry";
  if (Math.abs(lip_asym) > 0.03 && mouth_open < 0.06) return "disgust";
  if (eyes_narrow) return "sleepy";
  if (nose_cod > 0.03 && eye_open >= 0.18 && eye_open <= 0.26 && mouth_open < 0.06) return "thinking";
  if (Math.abs(head_tilt) > 0.05 && eye_open > 0.18) return "confused";

  return "neutral";
}

/* MediaPipe FaceMesh Setup */
const faceMesh = new FaceMesh({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
});

faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

let mpCamera = null;

/* ON RESULTS */
function onResults(results) {
  canvasElement.width = videoElement.videoWidth;
  canvasElement.height = videoElement.videoHeight;

  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
    emotionText.textContent = "No face";
    jokeBox.style.display = "none";
    lastEmotion = "No face";
    canvasCtx.restore();
    return;
  }

  const lm = results.multiFaceLandmarks[0];
  drawConnectors(canvasCtx, lm, FACEMESH_TESSELATION, { color: '#C0C0C070', lineWidth: 1 });
  drawLandmarks(canvasCtx, lm, { color: '#FF3030', radius: 1 });

  const f = get_features_from_landmarks(lm);
  const emotion = classify_emotion_js(f);
  emotionText.textContent = emotion;

  if (emotion === "sad") {
    jokeBox.style.display = "block";
    jokeBox.textContent = JOKES[Math.floor(Math.random()*JOKES.length)];
    jokeBtn.style.display = "inline-block";
  } else {
    jokeBox.style.display = "none";
    jokeBtn.style.display = "none";
  }

  const isSleepy = emotion.toLowerCase().includes("sleepy");
  const wasSleepy = lastEmotion.toLowerCase().includes("sleepy");

  if (isSleepy && !wasSleepy && audioUnlocked) {
    sleepySound.currentTime = 0;
    sleepySound.play().catch(console.warn);
  }

  if (!isSleepy && wasSleepy) {
    sleepySound.pause();
    sleepySound.currentTime = 0;
  }

  lastEmotion = emotion;
  canvasCtx.restore();
}

faceMesh.onResults(onResults);

/* Start Camera + Model */
async function startCameraAndModel() {
  loadingEl.style.display = "block";
  startBtn.disabled = true;

  try {
    mpCamera = new Camera(videoElement, {
      onFrame: async () => {
        await faceMesh.send({ image: videoElement });
      },
      width: 640,
      height: 480
    });

    mpCamera.start();
    await unlockAudio();

    /* Show only canvas */
    document.getElementById("camera-container").style.display = "block";
    loadingEl.style.display = "none";
  } catch (e) {
    console.error("Camera error:", e);
    loadingEl.textContent = "Camera error: " + e;
    startBtn.disabled = false;
  }
}

/* Handlers */
startBtn.addEventListener("click", startCameraAndModel);
jokeBtn.addEventListener("click", () => alert(jokeBox.textContent));

</script>
</body>
</html>
